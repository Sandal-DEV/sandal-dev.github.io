<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>가볍게 떠나는 여행 Sandal</title>
    <base href="/" />
    <link href="https://emoji-css.afeld.me/emoji.css" rel="stylesheet">
    <link href="css/app.css" rel="stylesheet" />
    <link href="Sandal.WASM.styles.css" rel="stylesheet" />
</head>

<body>
    <div id="app">Loading...</div>

    <div id="blazor-error-ui">
        An unhandled error has occurred.
        <a href="" class="reload">Reload</a>
        <a class="dismiss">🗙</a>
    </div>
    <script>
        function BlazorFocusElement(element) {
            if (element instanceof HTMLElement) {
                element.focus();
            }
        }

        function EnterKeyHandler(element) {
            var txtInput = document.getElementById("txtInput");
            if (element instanceof HTMLElement) {
                console.log("안녕?");

                element.focus();
                txtInput.focus();
                element.click();
                
            }
        }
        function activeBtn() {
            const sendBtn = document.querySelector('.chat-send-btn');
            const chatText = document.querySelector('.chat-textarea');
            if (chatText.value !== "") {
                sendBtn.id = "activate";
                sendBtn.disabled = false;
            } else if (chatText.value == "") {
                sendBtn.id = "";
                sendBtn.disabled = true;
            }
        }

        function enterHandler(event) {
            const keyCode = event.keyCode;
            const sendBtn = document.querySelector('.chat-send-btn');
            const chatText = document.querySelector('.chat-textarea');

            if (keyCode == 13) {
                if (!event.shiftKey) {
                    event.preventDefault();
                    DotNet.invokeMethodAsync("Sandal.WASM", 'OnSend');//.then(data => data);
                    chatText.value = "";
                } else {
                    chatText.value += "\r\n";
                }
            }
        }

        function getChatValue() {
            const chatText = document.querySelector('.chat-textarea');
            return chatText.value;
            //chatText.value = "";
        }
        class ChatDiv {
            constructor() {
                this._chatWrapDiv = document.createElement('div');
                this._profileDiv = document.createElement('div');
                this._iconI = document.createElement('i');
                this._userDiv = document.createElement('div');
                this._userNameDiv = document.createElement('div');
                this._chatMessageDiv = document.createElement('div');
                this._chatBubbleDiv = document.createElement('div');
                this._chatTimeDiv = document.createElement('div');

                this.setChatDiv();
            }

            setChatDiv() {
                this._chatWrapDiv.append(this._profileDiv);
                this._profileDiv.append(this._iconI);
                this._chatWrapDiv.append(this._userDiv);
                this._userDiv.append(this._userNameDiv);
                this._userDiv.append(this._chatMessageDiv);
                this._chatMessageDiv.append(this._chatBubbleDiv);
                this._chatMessageDiv.append(this._chatTimeDiv);

                this._chatWrapDiv.classList.add('live-chat');
                this._profileDiv.classList.add('user-profile');
                this._profileDiv.classList.add('user-border');
                this._userDiv.classList.add('user-chat');
                this._userNameDiv.classList.add('user-name');
                this._chatMessageDiv.classList.add('chat');
                this._chatBubbleDiv.classList.add('chat-bubble');
                this._chatTimeDiv.classList.add('chat-time');
            }
        }

        function renderChat(messagesJSON) {
            //const chatList = messagesJSON;
            document.querySelector('.live-chat-room').innerHTML="";
            messagesJSON.forEach(chat => {

                let chatDiv = new ChatDiv();
                chatDiv._chatWrapDiv.id = chat.type;
                chatDiv._iconI.className += chat.icon;
                chatDiv._userNameDiv.innerHTML = chat.user;
                chatDiv._profileDiv.style.borderColor = chat.color;
                chatDiv._chatBubbleDiv.innerHTML = chat.message;
                chatDiv._chatTimeDiv.innerHTML = chat.time;

                document.querySelector('.live-chat-room').append(chatDiv._chatWrapDiv);
            })
        }

        function scrollBottom() {
            const chatWrapDiv = document.querySelector('.live-chat-room');
            chatWrapDiv.scrollTop = chatWrapDiv.scrollHeight;
        }

        function setChatHeight() {
            let chatContainerHeight = window.innerHeight;//document.documentElement.clientHeight;
            let chatTitleHeight = document.querySelector('.live-chat-titlebar').offsetHeight;
            let chatInputHeight = document.querySelector('.live-chat-input').offsetHeight;

            return (chatContainerHeight - chatTitleHeight - chatInputHeight) + "px";
        }

        function setChatContainerHeight() {
            let chatContainerHeight = window.innerHeight;//document.documentElement.clientHeight;
            return chatContainerHeight + "px";
        }

        function registerResizeCallback() {
            window.addEventListener("resize", resized);
        }

        function resized() {
            DotNet.invokeMethodAsync("Sandal.WASM", 'OnBrowserResize').then(data => data);
        }
    </script>
    <script src="_framework/blazor.webassembly.js"></script>
    <script src="js/chat.js"></script>
    <script src="js/chatInput.js"></script>
</body>

</html>
